# Copyright (c) Facebook, Inc. and its affiliates.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.

version: 2.1

gpu: &gpu
  machine:
    image: ubuntu-2004-cuda-11.4:202110-01
  resource_class: gpu.nvidia.large

orbs:
  win: circleci/windows@5.0.0

executors:
  linux:
    machine:
      image: ubuntu:2004
    resource_class: 2xlarge
  linux-gpu:
    machine:
      image: ubuntu-2004-cuda-11.4:202110-01
    resource_class: gpu.nvidia.medium
  macos:
    macos:
      xcode: "13.4.1"
    resource_class: large
    environment:
      HOMEBREW_NO_AUTO_UPDATE: "1"
  windows:
    machine:
      image: win/default
    shell: bash.exe
    resource_class: 2xlarge
  windows-gpu:
    machine:
      image: win/server-2019-cuda
    shell: bash.exe
    resource_class: windows.gpu.nvidia.medium

commands:
  setup-cuda:
    parameters:
      platform:
        type: string
    steps:
      - when:
          condition:
            equal: ["linux-gpu", << parameters.platform >>]
          steps:
            - run:
                name: "Add CUDA 11.4 bin directory to PATH"
                command: |
                  echo 'export PATH="${PATH}:/usr/local/cuda-11.4/bin"' >> "$BASH_ENV"
      - when:
          condition:
            equal: ["windows-gpu", << parameters.platform >>]
          steps:
            - run:
                name: "Add CUDA 11.4 bin directory to PATH"
                command: |
                  echo "TODO: FIXME -- do we need to install CUDA?"
                  echo '' >> "$BASH_ENV"

  install_intel_libraries:
    parameters:
      platform:
        type: executor
      install_mkl:
        type: boolean
      install_onednn:
        type: boolean
    steps:
      - when:
          condition:
            or:
              - equal: ["linux-gpu", << parameters.platform >>]
              - equal: ["linux", << parameters.platform >>]
          steps:
            - run:
                name: "Setup Intel apt PPA"
                command: |
                  wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
                  sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
                  sudo sh -c 'echo deb https://apt.repos.intel.com/mkl all main > /etc/apt/sources.list.d/intel-mkl.list'
                  sudo apt update
            - when:
                condition: << parameters.install_mkl>>
                steps:
                  - run:
                      name: "Install Intel MKL"
                      command: sudo apt install intel-mkl-full
            - when:
                condition: << parameters.install_onednn>>
                steps:
                  - run:
                      name: "Install Intel MKL"
                      command: sudo apt install intel-onednn-dev
      - when:
          condition:
            equal: ["macos", << parameters.platform >>]
          steps:
            - run:
                name: "Setup Intel apt PPA"
                command: |
                  wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
                  sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
                  sudo sh -c 'echo deb https://apt.repos.intel.com/mkl all main > /etc/apt/sources.list.d/intel-mkl.list'
                  sudo apt update
            - when:
                condition: << parameters.install_mkl>>
                steps:
                  - run:
                      name: "Install Intel MKL"
                      command: sudo apt install intel-mkl-dev
            - when:
                condition: << parameters.install_onednn>>
                steps:
                  - run:
                      name: "Install Intel MKL"
                      command: sudo apt install intel-onednn-dev

  install-arrayfire:
    parameters:
      platform:
        type: string
    steps:
      - when:
          condition:
            or:
              - equal: ["linux-gpu", << parameters.platform >>]
              - equal: ["linux", << parameters.platform >>]
          steps:
            - run:
                name: "Install ArrayFire 3.8.1 PPA and prerequisites"
                command: |
                  sudo apt update
                  sudo apt install -y gnupg2 ca-certificates apt-utils software-properties-common
                  sudo apt update
                  sudo apt-key adv --fetch-key https://repo.arrayfire.com/GPG-PUB-KEY-ARRAYFIRE-2020.PUB
                  echo "deb [arch=amd64] https://repo.arrayfire.com/debian all main" | sudo tee /etc/apt/sources.list.d/arrayfire.list
                  sudo apt update
                  sudo apt install  arrayfire-cmake=3.8.1-2 arrayfire-headers=3.8.1-2
      - when:
          condition:
            equal: ["linux-gpu", << parameters.platform >>]
          steps:
            - run:
                name: "Install ArrayFire 3.8.1 with CUDA 11.4"
                command: |
                  sudo apt install arrayfire-cuda3-cuda-11-4=3.8.1-2 arrayfire-cuda3-dev=3.8.1-2
      - when:
          condition:
            equal: ["linux", << parameters.platform >>]
          steps:
            - run:
                name: "Install ArrayFire 3.8.1 with MKL"
                command: |
                  sudo apt install arrayfire-cpu3-mkl=3.8.1-2 arrayfire-cpu3-dev=3.8.1-2
      - when:
          condition:
            equal: ["macos", << parameters.platform >>]
          steps:
            - run:
                name: "Install ArrayFire 3.8.1"
                command: brew install arrayfire

  install-cudnn:
    parameters:
      platform:
        type: string
    steps:
      - when:
          condition:
            equal: ["linux-gpu", << parameters.platform >>]
          steps:
            - run:
                name: "Install cuDNN 8.5.0.96 for CUDA 11.7"
                command: |
                  cd /tmp
                  wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/libcudnn8_8.5.0.96-1+cuda11.7_amd64.deb
                  wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/libcudnn8-dev_8.5.0.96-1+cuda11.7_amd64.deb
                  sudo dpkg -i libcudnn8_8.5.0.96-1+cuda11.7_amd64.deb libcudnn8-dev_8.5.0.96-1+cuda11.7_amd64.deb
      - when:
          condition:
            equal: ["windows-gpu", << parameters.platform >>]
          steps:
            - run:
                name: "Install cuDNN 8.5.0.96 for CUDA 11.7"
                command: |
                  echo "TODO: FIXME - install cuDNN, maybe use choco CUDA"

  build_flashlight:
    parameters:
      fl_use_arrayfire:
        default: "OFF"
        type: string
      fl_arrayfire_use_cuda:
        default: "OFF"
        type: string
      fl_arrayfire_use_cpu:
        default: "OFF"
        type: string
      fl_use_cudnn:
        default: "OFF"
        type: string
      fl_use_onednn:
        default: "OFF"
        type: string
      fl_build_distributed:
        default: "OFF"
        type: string
    steps:
      - run:
          name: "Build Flashlight"
          command: |
            cmake -S . -B build \
              -DFL_USE_ARRAYFIRE=<< parameters.fl_use_arrayfire >> \
              -DFL_ARRAYFIRE_USE_CUDA=<< parameters.fl_arrayfire_use_cuda >> \
              -DFL_ARRAYFIRE_USE_CPU=<< parameters.fl_arrayfire_use_cpu >> \
              -DFL_USE_CUDNN=<< parameters.fl_arrayfire_use_cpu >> \
              -DFL_USE_ONEDNN=<< parameters.fl_use_onednn >> \
              -DFL_BUILD_DISTRIBUTED=<< parameters.fl_build_distributed >>
            cmake --build build --parallel

  test_flashlight:
    parameters:
      path:
        default: "OFF"
        type: string
    steps:
      - run:
          name: "Test Flashlight"
          command: |
            cd << parameters.path >>
            ctest --verbose --parallel 4

  ############################### Old Commands ###############################

  # Default cmake inside docker will be tested with docker build
  build_flashlight_inside_nvidia_docker:
    parameters:
      fl_arrayfire_use_cuda:
        default: "OFF"
        type: string
      fl_arrayfire_use_cpu:
        default: "OFF"
        type: string
      fl_use_cudnn:
        default: "OFF"
        type: string
      fl_use_onednn:
        default: "OFF"
        type: string
      fl_build_fl_core:
        default: "OFF"
        type: string
      # pkgs
      fl_build_pkg_vision:
        default: "OFF"
        type: string
      fl_build_pkg_common:
        default: "OFF"
        type: string
      fl_build_pkg_speech:
        default: "OFF"
        type: string
      fl_build_pkg_text:
        default: "OFF"
        type: string
      fl_build_pkg_runtime:
        default: "OFF"
        type: string
      # Apps
      fl_build_app_asr:
        default: "OFF"
        type: string
      fl_build_app_imgclass:
        default: "OFF"
        type: string
      fl_build_app_objdet:
        default: "OFF"
        type: string
      fl_build_app_lm:
        default: "OFF"
        type: string
      build_shared_libs:
        default: "OFF"
        type: string
      fl_code_coverage:
        default: "ON"
        type: string
      version:
        default: "3.16"
        type: string
      version_build:
        default: "1"
        type: string
    steps:
      - run:
          name: "Build and Install Flashlight inside of NVIDIA Docker"
          command: |
            sudo docker exec -it flashlight bash -c "\
            echo 'deb http://archive.ubuntu.com/ubuntu xenial main' | tee /etc/apt/sources.list.d/xenial.list && \
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends software-properties-common && \
            apt-add-repository -r universe && apt-add-repository 'deb http://dk.archive.ubuntu.com/ubuntu/ bionic main' && apt-add-repository 'deb http://dk.archive.ubuntu.com/ubuntu/ bionic universe' && apt-get update && \
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends gcc-7 g++-7 && \
            update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 7 &&\
            update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-7 7 && \
            update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-7 7 && \
            wget https://cmake.org/files/v<< parameters.version >>/cmake-<< parameters.version >>.<< parameters.version_build >>-Linux-x86_64.sh && \
            mkdir /opt/cmake && \
            sh cmake-<< parameters.version >>.<< parameters.version_build >>-Linux-x86_64.sh --prefix=/opt/cmake --skip-license && \
            ln -s /opt/cmake/bin/cmake /usr/local/bin/cmake && \
            cd /flashlight && pwd && ls && mkdir -p build && cd build && \
            export MKLROOT=/opt/intel/mkl && \
            cmake .. \
                -DFL_ARRAYFIRE_USE_CUDA=<< parameters.fl_arrayfire_use_cuda >> \
                -DFL_ARRAYFIRE_USE_CPU=<< parameters.fl_arrayfire_use_cpu >> \
                -DFL_USE_CUDNN=<< parameters.fl_use_cudnn >> \
                -DFL_USE_ONEDNN=<< parameters.fl_use_onednn >> \
                -DFL_BUILD_CORE=<< parameters.fl_build_fl_core >> \
                -DFL_BUILD_PKG_RUNTIME=<< parameters.fl_build_pkg_runtime >> \
                -DFL_BUILD_PKG_VISION=<< parameters.fl_build_pkg_vision >> \
                -DFL_BUILD_PKG_TEXT=<< parameters.fl_build_pkg_text >> \
                -DFL_BUILD_PKG_SPEECH=<< parameters.fl_build_pkg_speech >> \
                -DFL_BUILD_APP_ASR=<< parameters.fl_build_app_asr >> \
                -DFL_BUILD_APP_IMGCLASS=<< parameters.fl_build_app_imgclass >> \
                -DFL_BUILD_APP_OBJDET=<< parameters.fl_build_app_objdet >> \
                -DFL_BUILD_APP_LM=<< parameters.fl_build_app_lm >> \
                -DBUILD_SHARED_LIBS=<< parameters.build_shared_libs >> \
                -DFL_CODE_COVERAGE=<< parameters.fl_code_coverage >> && \
            make -j$(nproc) && make install"
  run_codecov_inside_nvidia_docker:
    parameters:
      coverage_flag:
        type: string
    steps:
      - run:
          name: "Get code coverage inside of NVIDIA Docker"
          command: |
            sudo docker exec -it --env CODECOV_TOKEN=$CODECOV_TOKEN flashlight bash -c "\
                DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends lcov curl && \
                cd /flashlight && \
                lcov --capture --directory . --output-file coverage.info && \
                lcov --remove coverage.info '/usr/*' --output-file coverage.info &&
                lcov --remove coverage.info '*/include/af/*' --output-file coverage.info && \
                lcov --remove coverage.info '*/gtest/*' --output-file coverage.info && \
                lcov --list coverage.info && \
                bash <(curl -s https://codecov.io/bash) -f coverage.info \
                -F << parameters.coverage_flag >> \
                -t $CODECOV_TOKEN \
                || echo 'Codecov did not collect coverage reports'"

############################ Jobs ############################
jobs:
  build-and-test-main:
    parameters:
      platform:
        type: string
      backend:
        type: string
    executor: << parameters.platform >>
    steps:
      - checkout
      - when:
          condition:
            or:
              - equal: ["linux-gpu", << parameters.platform >>]
              - equal: ["windows-gpu", << parameters.platform >>]
          steps:
            # - run: echo "Hello"
            - setup-cuda:
                platform: << parameters.platform >>
      - when:
          condition:
            equal: ["arrayfire", << parameters.backend >>]
          steps:
            - install-arrayfire:
                platform: << parameters.platform >>
      - when:
          condition:
            or:
              - equal: ["linux-gpu", << parameters.platform >>]
              - equal: ["windows-gpu", << parameters.platform >>]
          steps:
            - install-cudnn:
                platform: << parameters.platform >>
      - build_flashlight:
          fl_use_arrayfire: "ON"
          fl_arrayfire_use_cuda: "ON"
          fl_use_cudnn: "ON"
      - test_flashlight:
          path: build/flashlight/fl/test

workflows:
  version: 2
  build-and-test-new:
    jobs:
      - build-and-test-main:
          name: "Build and Test"
          matrix:
            parameters:
              platform: [linux, linux-gpu, macos, windows, windows-gpu]
              backend: [arrayfire, onednn]
            exclude:
              - platform: linux-gpu
                backend: onednn
              - platform: windows-gpu
                backend: onednn