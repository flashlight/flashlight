# Copyright (c) Facebook, Inc. and its affiliates.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.

version: 2.1

gpu: &gpu
  machine:
    image: ubuntu-1604-cuda-10.1:201909-23
  resource_class: gpu.small

commands:
  authenticate_docker:
    steps:
      - run:
          name: "Authenticate Docker"
          command: |
            if [ ! -z "$DOCKER_USERNAME" ]
            then
                sudo docker login -u=$DOCKER_USERNAME -p=$DOCKER_PASSWORD
            fi
  install_cuda_linux:
    parameters:
      version:
        default: "10.0"
        type: string
    steps:
      - run:
          name: Install CUDA 10.0
          command: |
            wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_10.0.130-1_amd64.deb
            sudo dpkg -i cuda-repo-ubuntu1604_10.0.130-1_amd64.deb
            sudo apt-get update || true
            sudo apt-get --yes --force-yes install cuda
            nvidia-smi
jobs:
  ubuntu_1604_gcc5_cuda_10_1_docker:
    <<: *gpu
    steps:
      - checkout
      - authenticate_docker
      - run:
          name: Build flashlight with CUDA backend inside nvidia-docker
          command: |
            sudo docker run --runtime=nvidia --rm -itd --ipc=host --name flashlight flml/flashlight:cuda-base-consolidation-latest
            sudo docker exec -it flashlight bash -c "mkdir /flashlight"
            sudo docker cp . flashlight:/flashlight
            sudo docker exec -it flashlight bash -c "\
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends gcc-5 g++-5 && \
            cd /flashlight && pwd && ls && mkdir -p build && cd build && \
            export CC=/usr/bin/gcc-5 && export CXX=/usr/bin/g++-5 && \
            export MKLROOT=/opt/intel/mkl && export KENLM_ROOT=/root/kenlm && \
            cmake .. -DFL_BACKEND=CUDA && \
            make -j$(nproc) && make install && make test"
  build-cpu:
    docker:
      - image: flml/flashlight:cpu-base-consolidation-latest
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout:
          path: flashlight
      - run:
          name: Build flashlight with CPU backend
          command: |
            cd flashlight && apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends gcc-5 g++-5
            export CC=/usr/bin/gcc-5 && export CXX=/usr/bin/g++-5
            export MKLROOT=/opt/intel/mkl && export KENLM_ROOT=/root/kenlm
            mkdir -p build && cd build
            cmake .. -DFL_BACKEND=CPU -DFL_LIBRARIES_USE_CUDA=OFF
            make -j1 && make install
workflows:
  version: 2
  build_and_install:
    jobs:
      - ubuntu_1604_gcc5_cuda_10_1_docker
      - build-cpu
